<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebRTC Signaling через файлы</title>
    <style>
      body { font-family: Arial, sans-serif; padding:20px; }
      video { width: 100%; max-width: 320px; height: auto; background: #000; }
      .videos { display: flex; flex-direction: column; gap:20px; }
      @media(min-width:700px){ .videos { flex-direction: row; } }
      textarea { width:100%; height:120px; margin-top:12px; }
      button { margin: 6px 6px 0 0; }
    </style>
  </head>
  <body>
    <h1>WebRTC видеозвонки (обмен Offer/Answer через файлы)</h1>

    <div class="videos">
      <div>
        <h3>Местное</h3>
        <video id="localVideo" autoplay muted playsinline></video>
      </div>
      <div>
        <h3>Удалённое</h3>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
    </div>

    <h3>Offer</h3>
    <button onclick="createOffer()">Создать Offer</button>
    <button onclick="saveToFile('offerBox', 'offer.json')">Сохранить Offer в файл</button>
    <input type="file" id="offerFile" onchange="loadFromFile(event, 'offerBox')" />
    <textarea id="offerBox" placeholder="Offer SDP"></textarea>

    <h3>Answer</h3>
    <button onclick="createAnswer()">Создать Answer</button>
    <button onclick="saveToFile('answerBox', 'answer.json')">Сохранить Answer в файл</button>
    <input type="file" id="answerFile" onchange="loadFromFile(event, 'answerBox')" />
    <textarea id="answerBox" placeholder="Answer SDP"></textarea>

    <div>
      <button onclick="setRemoteAnswer()">Применить Answer</button>
    </div>

    <script>
      let pc;
      const localVideo = document.getElementById('localVideo');
      const remoteVideo = document.getElementById('remoteVideo');
      const offerBox = document.getElementById('offerBox');
      const answerBox = document.getElementById('answerBox');

      async function init(){
        if(location.protocol !== 'https:' && location.hostname !== 'localhost'){
          alert('⚠️ Для Android 15 требуется HTTPS или localhost.');
          return;
        }

        pc = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });

        pc.ontrack = (e) => {
          remoteVideo.srcObject = e.streams[0];
        };

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
          localVideo.srcObject = stream;
          stream.getTracks().forEach(track => pc.addTrack(track, stream));
        } catch(err) {
          console.error(err);
          alert('Ошибка доступа: ' + err.name + ' — ' + err.message);
        }

        pc.onicecandidate = () => {
          if (pc.iceGatheringState === 'complete') {
            if (pc.localDescription.type === 'offer') {
              offerBox.value = JSON.stringify(pc.localDescription);
            } else if (pc.localDescription.type === 'answer') {
              answerBox.value = JSON.stringify(pc.localDescription);
            }
          }
        };
      }
      init();

      async function createOffer(){
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
      }

      async function createAnswer(){
        const remoteOffer = JSON.parse(offerBox.value);
        await pc.setRemoteDescription(new RTCSessionDescription(remoteOffer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
      }

      async function setRemoteAnswer(){
        const remote = JSON.parse(answerBox.value);
        await pc.setRemoteDescription(new RTCSessionDescription(remote));
      }

      function saveToFile(textareaId, filename){
        const text = document.getElementById(textareaId).value;
        const blob = new Blob([text], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
      }

      function loadFromFile(event, textareaId){
        const file = event.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          document.getElementById(textareaId).value = e.target.result;
        };
        reader.readAsText(file);
      }
    </script>

    <p><strong>Как пользоваться:</strong></p>
    <ol>
      <li>На устройстве А нажмите «Создать Offer» и «Сохранить Offer в файл». Передайте файл устройству B.</li>
      <li>На устройстве B загрузите файл Offer, нажмите «Создать Answer» и сохраните его в файл. Передайте обратно устройству A.</li>
      <li>На устройстве A загрузите файл Answer и нажмите «Применить Answer».</li>
    </ol>
  </body>
</html>
