<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebRTC Manual Signaling (Offer/Answer)</title>
    <style>
      body { font-family: Arial, sans-serif; padding:20px; }
      video { width: 100%; max-width: 320px; height: auto; background: #000; }
      .videos { display: flex; flex-direction: column; gap:20px; }
      @media(min-width:700px){ .videos { flex-direction: row; } }
      textarea { width:100%; height:120px; margin-top:12px; }
      button { margin: 6px 6px 0 0; }
    </style>
  </head>
  <body>
    <h1>Персональные видеозвонки (WebRTC без сигналинг-сервера)</h1>

    <div class="videos">
      <div>
        <h3>Местное</h3>
        <video id="localVideo" autoplay muted playsinline></video>
      </div>
      <div>
        <h3>Удалённое</h3>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
    </div>

    <h3>Offer</h3>
    <button onclick="createOffer()">Создать Offer</button>
    <button onclick="copyToClipboard('offerBox')">Копировать Offer</button>
    <textarea id="offerBox" placeholder="Offer SDP"></textarea>

    <h3>Answer</h3>
    <button onclick="createAnswer()">Создать Answer</button>
    <button onclick="copyToClipboard('answerBox')">Копировать Answer</button>
    <textarea id="answerBox" placeholder="Answer SDP"></textarea>

    <div>
      <button onclick="setRemoteOffer()">Применить Offer</button>
      <button onclick="setRemoteAnswer()">Применить Answer</button>
    </div>

    <script>
      let pc;
      const localVideo = document.getElementById('localVideo');
      const remoteVideo = document.getElementById('remoteVideo');
      const offerBox = document.getElementById('offerBox');
      const answerBox = document.getElementById('answerBox');

      async function init(){
        if(location.protocol !== 'https:' && location.hostname !== 'localhost'){
          alert('⚠️ Для Android 15 требуется HTTPS или localhost.');
          return;
        }

        pc = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });

        pc.ontrack = (e) => {
          remoteVideo.srcObject = e.streams[0];
        };

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
          localVideo.srcObject = stream;
          stream.getTracks().forEach(track => pc.addTrack(track, stream));
        } catch(err) {
          console.error(err);
          alert('Ошибка доступа: ' + err.name + ' — ' + err.message);
        }

        pc.onicecandidate = () => {
          if (pc.iceGatheringState === 'complete') {
            if (pc.localDescription.type === 'offer') {
              offerBox.value = JSON.stringify(pc.localDescription);
            } else if (pc.localDescription.type === 'answer') {
              answerBox.value = JSON.stringify(pc.localDescription);
            }
          }
        };
      }
      init();

      async function createOffer(){
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
      }

      async function createAnswer(){
        const remoteOffer = JSON.parse(offerBox.value);
        await pc.setRemoteDescription(new RTCSessionDescription(remoteOffer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
      }

      async function setRemoteOffer(){
        const remote = JSON.parse(offerBox.value);
        await pc.setRemoteDescription(new RTCSessionDescription(remote));
      }

      async function setRemoteAnswer(){
        const remote = JSON.parse(answerBox.value);
        await pc.setRemoteDescription(new RTCSessionDescription(remote));
      }

      function copyToClipboard(id){
        const box = document.getElementById(id);
        box.select();
        document.execCommand('copy');
        alert('Скопировано в буфер обмена');
      }
    </script>

    <p><strong>Как пользоваться:</strong></p>
    <ol>
      <li>На устройстве А нажмите «Создать Offer» и «Копировать Offer». Передайте текст устройству B.</li>
      <li>На устройстве B вставьте Offer в поле и нажмите «Создать Answer». Скопируйте Answer и передайте устройству A.</li>
      <li>На устройстве A вставьте Answer в поле и нажмите «Применить Answer».</li>
    </ol>
  </body>
</html>
